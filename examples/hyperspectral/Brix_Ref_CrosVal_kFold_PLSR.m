% Analisis Data Spectral using Partial Least Square (PLS)

close all
clear all
clc

rng(1);

numFolding  = 10;
nComp       = 20;

[FileName,PathName,~] = uigetfile('*.MAT', 'Pilih file Feature Set', 'MultiSelect', 'off');
if isequal(FileName, 0)
    msgbox('Pembatalan dilakukan', 'Canceled');
    return
end

load([PathName FileName]);

% Check Type of Class
UnikKelas_1     = unique(kelas_1);
kelas_1_idx     = cell(size(UnikKelas_1));
kelas_1_str     = cell(size(UnikKelas_1));
for i=1:size(UnikKelas_1,1)
    kelas_1_str{i}  = upper(UnikKelas_1{i,1});
    kelasIdx        = strfind(kelas_1, kelas_1_str{i});
    kelas_1_idx{i}  = find(not(cellfun('isempty', kelasIdx)));
end

% Check the atribute name and value
% atribut_1_name   = unique(atribut_1_name);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
% atribut_2_name   = unique(atribut_2_name);
% atribut_3_name   = unique(atribut_3_name);
% atribut_4_name   = unique(atribut_4_name);
% atribut_5_name   = unique(atribut_5_name);

% if exist('cropTransmitance', 'var')
%     Transmitance     = cropTransmitance;
% elseif exist('cropContrast', 'var')
%     Transmitance     = [cropEnergy, cropHomogeneity];
% else
%     disp('Transmitance data is not exist');
%     return;
% end

Reflectance = [cropReflectance];

%Pilih class untuk klasifikasi
atributVal  = atribut_1_val;
%atributName = atribut_1_name{1};

%disp(['Nama Atribute ' atributName]);

CVO         = cvpartition(kelas_1,'k',numFolding);

rmsePLSRTr    = zeros(CVO.NumTestSets,1);
rmsePLSRTt    = zeros(CVO.NumTestSets,1);
rmspePLSRTr    = zeros(CVO.NumTestSets,1);
rmspePLSRTt    = zeros(CVO.NumTestSets,1);
corrCoeffTr   = zeros(CVO.NumTestSets,1);
corrCoeffTt   = zeros(CVO.NumTestSets,1);
errSVMTr      = zeros(CVO.NumTestSets,1);
errSVMTe      = zeros(CVO.NumTestSets,1);
testNo        = zeros(CVO.NumTestSets,1);

for i = 1:CVO.NumTestSets
    testNo(i) = i;
    trIdx = CVO.training(i);
    ttIdx = CVO.test(i);
    
    % Train PLSR
    [XL,YL,XS,YS,Beta,PCTVAR,MSE,stats] = plsregress(Reflectance(trIdx,:),atributVal(trIdx), nComp);
    
    % Testing PLSR on Training Data
    atributValPLSTr   = [ones(size(Reflectance(trIdx,:),1),1) Reflectance(trIdx,:)]*Beta;
    rmsePLSRTr(i)     = errPerf(atributVal(trIdx),atributValPLSTr,'rmse');
    rmspePLSRTr(i)     = errPerf(atributVal(trIdx),atributValPLSTr,'rmspe');
    
    % Testing PLSR on Testing Data
    atributValPLSTe   = [ones(size(Reflectance(ttIdx,:),1),1) Reflectance(ttIdx,:)]*Beta;
    rmsePLSRTt(i)     = errPerf(atributVal(ttIdx),atributValPLSTe,'rmse');
    rmspePLSRTt(i)     = errPerf(atributVal(ttIdx),atributValPLSTe,'rmspe');
    
    % Testing - Correlation coefficients on Training Data
    [p,S,mu]        = polyfit(atributVal(trIdx),atributValPLSTr,1);
    R               = corrcoef(atributVal(trIdx),atributValPLSTr);
    corrCoeffTr(i)  = R(1,2);
    
    % Testing - Correlation coefficients on Testing Data
    [p,S,mu]        = polyfit(atributVal(ttIdx),atributValPLSTe,1);
    R               = corrcoef(atributVal(ttIdx),atributValPLSTe);
    corrCoeffTt(i)  = R(1,2);
end

% Plot Variance per Component
 plot(1:20,cumsum(100*PCTVAR(2,:)),'-bo');
 xlabel('Number of PLS components');
 ylabel('Percent Variance Explained in Y');
    
errorTable = table(testNo, rmsePLSRTr, rmspePLSRTr, rmsePLSRTt, rmspePLSRTt, corrCoeffTr, corrCoeffTt);
disp(errorTable);

disp(['Rata-rata RMSE PLSR on Training Data ' num2str(mean(rmsePLSRTr), '%.2f')]);
disp(['Rata-rata RMSE(%) PLSR on Training Data ' num2str(mean(rmspePLSRTr), '%.2f'),'%']);
disp(['Rata-rata RMSE PLSR on Testing Data ' num2str(mean(rmsePLSRTt), '%.2f')]);
disp(['Rata-rata RMSE(%) PLSR on Testing Data ' num2str(mean(rmspePLSRTt), '%.2f'),'%']);
disp(['Rata-rata Correlation Coefisient on Training Data ' num2str(mean(corrCoeffTr))]);
disp(['Rata-rata Correlation Coefisient on Testing Data ' num2str(mean(corrCoeffTt))]);